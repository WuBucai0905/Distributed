# çº¿ç¨‹

GILå…¨å±€é”å®é™…ä¸ŠæŠŠæ‰€æœ‰çº¿ç¨‹çš„æ‰§è¡Œä»£ç éƒ½ç»™ä¸Šäº†é”ï¼Œæ‰€ä»¥ï¼Œå¤šçº¿ç¨‹åœ¨Pythonä¸­åªèƒ½äº¤æ›¿æ‰§è¡Œï¼Œå³ä½¿100ä¸ªçº¿ç¨‹è·‘åœ¨100æ ¸CPUä¸Šï¼Œä¹Ÿåªèƒ½ç”¨åˆ°1ä¸ªæ ¸ã€‚

## åˆ›å»ºå¤šçº¿ç¨‹

### æ–¹æ³•

- å‡½æ•°
- ç±»

#### å‡½æ•°

```
import  threading
threading.Thread( target=è°ƒç”¨æ–¹æ³•, args=å¯¹æ–¹æ³•ä¼ å‚ ) 
```

#### ç±»

- å¿…é¡»ç»§æ‰¿ `threading.Thread` è¿™ä¸ªçˆ¶ç±»ï¼›
- å¿…é¡»å¤å†™ `run` æ–¹æ³•

è¿™é‡Œçš„ `run` æ–¹æ³•ï¼Œå’Œæˆ‘ä»¬ä¸Šé¢`çº¿ç¨‹å‡½æ•°`çš„æ€§è´¨æ˜¯ä¸€æ ·çš„ï¼Œå¯ä»¥å†™æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ç¨‹åºã€‚åœ¨ `start()` åå°†ä¼šè°ƒç”¨

## çº¿ç¨‹å¯¹è±¡çš„æ–¹æ³•

```
# å¯åŠ¨å­çº¿ç¨‹
t.start()

# é˜»å¡å­çº¿ç¨‹ï¼Œå¾…å­çº¿ç¨‹ç»“æŸåï¼Œå†å¾€ä¸‹æ‰§è¡Œ
# å­çº¿ç¨‹å®Œæˆè¿è¡Œä¹‹å‰ï¼Œè¿™ä¸ªå­çº¿ç¨‹çš„çˆ¶çº¿ç¨‹å°†ä¸€ç›´è¢«é˜»å¡ã€‚
# æ³¨æ„:join()æ–¹æ³•çš„ä½ç½®æ˜¯åœ¨forå¾ªç¯å¤–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¿…é¡»ç­‰å¾…forå¾ªç¯é‡Œçš„çº¿ç¨‹éƒ½ç»“æŸåï¼Œæ‰å»æ‰§è¡Œä¸»çº¿ç¨‹ã€‚
t.join()

# åˆ¤æ–­çº¿ç¨‹æ˜¯å¦åœ¨æ‰§è¡ŒçŠ¶æ€ï¼Œåœ¨æ‰§è¡Œè¿”å›Trueï¼Œå¦åˆ™è¿”å›False
t.is_alive()
t.isAlive()

# è®¾ç½®çº¿ç¨‹æ˜¯å¦éšä¸»çº¿ç¨‹é€€å‡ºè€Œé€€å‡ºï¼Œé»˜è®¤ä¸ºFalse
t.daemon = True
t.daemon = False

# è®¾ç½®çº¿ç¨‹å
t.name = "My-Thread"

setDaemon(True)å°†çº¿ç¨‹å£°æ˜ä¸ºå®ˆæŠ¤çº¿ç¨‹ , å¿…é¡»åœ¨start() æ–¹æ³•è°ƒç”¨ä¹‹å‰è®¾ç½®ï¼Œå¦‚æœä¸è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ç¨‹åºä¼šè¢«æ— é™æŒ‚èµ·ã€‚ 
```

## çº¿ç¨‹é”

### äº’æ–¥é”

#### åŠ é”

```
# ç”Ÿæˆé”å¯¹è±¡ï¼Œå…¨å±€å”¯ä¸€
lock = threading.Lock()
```

#### è·å–é’¥åŒ™ğŸ”‘

```
# è·å–é”ã€‚æœªè·å–åˆ°ä¼šé˜»å¡ç¨‹åºï¼Œç›´åˆ°è·å–åˆ°é”æ‰ä¼šå¾€ä¸‹æ‰§è¡Œ
lock.acquire()
```

#### é‡Šæ”¾é”

```
# é‡Šæ”¾é”ï¼Œå½’è¿˜é”ï¼Œå…¶ä»–äººå¯ä»¥æ‹¿å»ç”¨äº†
lock.release()
```

lock.acquire() å’Œ lock.release()å¿…é¡»æˆå¯¹å‡ºç°ã€‚å¦åˆ™å°±æœ‰å¯èƒ½é€ æˆæ­»é”ã€‚

ä¸ºäº†è§„é¿è¿™ä¸ªé—®é¢˜ã€‚æˆ‘æ¨èä½¿ç”¨ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ¥åŠ é”

```
lock = threading.Lock()
# with è¯­å¥ä¼šåœ¨è¿™ä¸ªä»£ç å—æ‰§è¡Œå‰è‡ªåŠ¨è·å–é”ï¼Œåœ¨æ‰§è¡Œç»“æŸåè‡ªåŠ¨é‡Šæ”¾é”
with lock:
    # è¿™é‡Œå†™è‡ªå·±çš„ä»£ç 
    pass
```

### å¯é‡å…¥é”ï¼ˆRLockï¼‰

æœ‰æ—¶å€™åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¤šæ¬¡è¯·æ±‚åŒä¸€èµ„æºï¼Œä¿—ç§°é”åµŒå¥—ã€‚æŒ‰ç…§å¸¸è§„çš„åšæ³•ï¼Œä¼šé€ æˆæ­»é”çš„

å¯é‡å…¥é”ï¼ˆRLockï¼‰ï¼Œåªåœ¨åŒä¸€çº¿ç¨‹é‡Œæ”¾æ¾å¯¹é”(é€šè¡Œè¯)çš„è·å–ï¼Œæ„æ€æ˜¯ï¼Œåªè¦åœ¨åŒä¸€çº¿ç¨‹é‡Œï¼Œç¨‹åºå°±å½“ä½ æ˜¯åŒä¸€ä¸ªäººï¼Œè¿™ä¸ªé”å°±å¯ä»¥å¤ç”¨ï¼Œå…¶ä»–çš„è¯ä¸`Lock`å¹¶æ— åŒºåˆ«

RLockå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªLockå’Œä¸€ä¸ªcounterå˜é‡ï¼Œcounterè®°å½•äº†acquireçš„æ¬¡æ•°ï¼Œä»è€Œä½¿å¾—èµ„æºå¯ä»¥è¢«å¤šæ¬¡requireã€‚ç›´åˆ°ä¸€ä¸ªçº¿ç¨‹æ‰€æœ‰çš„acquireéƒ½è¢«releaseï¼Œå…¶ä»–çš„çº¿ç¨‹æ‰èƒ½è·å¾—èµ„æºã€‚ 

```
ä¿¡å·é‡
Semaphoreç®¡ç†ä¸€ä¸ªå†…ç½®çš„è®¡æ•°å™¨ï¼Œ
æ¯å½“è°ƒç”¨acquire()æ—¶å†…ç½®è®¡æ•°å™¨-1ï¼›
è°ƒç”¨release() æ—¶å†…ç½®è®¡æ•°å™¨+1ï¼›
è®¡æ•°å™¨ä¸èƒ½å°äº0ï¼›å½“è®¡æ•°å™¨ä¸º0æ—¶ï¼Œacquire()å°†é˜»å¡çº¿ç¨‹ç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨release()ã€‚
è¿›ç¨‹æ± ä»å¤´åˆ°å°¾åªæœ‰è§„å®šçš„è¿›ç¨‹æ•°é‡,è€Œä¿¡å·é‡æ˜¯äº§ç”Ÿä¸€å †çº¿ç¨‹/è¿›ç¨‹
```

### é˜²æ­¢æ­»é”çš„åŠ é”æœºåˆ¶

æ­»é”é€šå¸¸ä»¥ä¸‹å‡ ç§

- åŒä¸€çº¿ç¨‹ï¼ŒåµŒå¥—è·å–åŒæŠŠäº’æ–¥é”ï¼Œé€ æˆæ­»é”

RLock

- å¤šä¸ªçº¿ç¨‹ï¼Œä¸æŒ‰é¡ºåºåŒæ—¶è·å–å¤šä¸ªé”ã€‚é€ æˆæ­»é”

```
çº¿ç¨‹1ï¼ŒåµŒå¥—è·å–A,Bä¸¤ä¸ªé”ï¼Œçº¿ç¨‹2ï¼ŒåµŒå¥—è·å–B,Aä¸¤ä¸ªé”ã€‚ ç”±äºä¸¤ä¸ªçº¿ç¨‹æ˜¯äº¤æ›¿æ‰§è¡Œçš„ï¼Œæ˜¯æœ‰æœºä¼šé‡åˆ°çº¿ç¨‹1è·å–åˆ°é”Aï¼Œè€Œæœªè·å–åˆ°é”Bï¼Œåœ¨åŒä¸€æ—¶åˆ»ï¼Œçº¿ç¨‹2è·å–åˆ°é”Bï¼Œè€Œæœªè·å–åˆ°é”Aã€‚ç”±äºé”Bå·²ç»è¢«çº¿ç¨‹2è·å–äº†ï¼Œæ‰€ä»¥çº¿ç¨‹1å°±å¡åœ¨äº†è·å–é”Bå¤„ï¼Œç”±äºæ˜¯åµŒå¥—é”ï¼Œçº¿ç¨‹1æœªè·å–å¹¶é‡Šæ”¾Bï¼Œæ˜¯ä¸èƒ½é‡Šæ”¾é”Açš„ï¼Œè¿™æ˜¯å¯¼è‡´çº¿ç¨‹2ä¹Ÿè·å–ä¸åˆ°é”Aï¼Œä¹Ÿå¡ä½äº†ã€‚ä¸¤ä¸ªçº¿ç¨‹ï¼Œå„æ‰§ä¸€é”ï¼Œå„ä¸è®©æ­¥ã€‚é€ æˆæ­»é”ã€‚
```

**join å’Œ äº’æ–¥é” éƒ½å¯ä»¥å®ç° ä¸²è¡Œè¿è¡Œçš„æ•ˆæœ**

çº¿ç¨‹æŠ¢ GILé”(ç›¸å½“äº æ‰§è¡Œæƒé™),  -->  æ‹¿åˆ°æ‰§è¡Œæƒé™å æ‰èƒ½æ‹¿åˆ° äº’æ–¥é”(lock), å¦‚æœlockæ²¡æœ‰è¢«é‡Šæ”¾åˆ™å µå¡,æƒé™ä¼šç«‹åˆ»äº¤å‡ºæ¥.

GILé”æ˜¯è§£é‡Šå™¨çº§åˆ«çš„,ä¿æŠ¤çš„æ˜¯è§£é‡Šå™¨çº§åˆ«çš„æ•°æ®,æ¯”å¦‚åƒåœ¾å›æ”¶çš„æ•°æ®

lockæ˜¯ä¿æŠ¤è‡ªå·±å¼€å‘çš„åº”ç”¨ç¨‹åºçš„æ•°æ®

**join å’Œ äº’æ–¥é” çš„åŒºåˆ«**

join ä»»åŠ¡é‡Œçš„æ‰€æœ‰ä»£ç  éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„;

åŠ é” åªæ˜¯åŠ é”çš„éƒ¨åˆ†å³ä¿®æ”¹å…±äº«æ•°æ®çš„éƒ¨åˆ† æ˜¯ä¸²è¡Œçš„

## åˆ›å»ºçº¿ç¨‹æ± 

å¤šçº¿ç¨‹å¤„ç†ä»»åŠ¡æ—¶ä¹Ÿä¸æ˜¯çº¿ç¨‹è¶Šå¤šè¶Šå¥½ï¼Œç”±äºåœ¨åˆ‡æ¢çº¿ç¨‹çš„æ—¶å€™ï¼Œéœ€è¦åˆ‡æ¢ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¾ç„¶ä¼šé€ æˆcpuçš„å¤§é‡å¼€é”€

### å†…ç½®æ¨¡å—

åˆ›å»ºçº¿ç¨‹æ± æ˜¯é€šè¿‡`concurrent.futures`å‡½æ•°åº“ä¸­çš„`ThreadPoolExecutor`ç±»æ¥å®ç°

```
import time
import threading
from concurrent.futures import ThreadPoolExecutor

def target():
    for i in range(5):
        print('running thread-{}:{}'.format(threading.get_ident(), i))
        time.sleep(1)

# åˆ›å»ºä¸€ä¸ªæœ€å¤§å®¹çº³æ•°é‡ä¸º5çš„çº¿ç¨‹æ± 
pool = ThreadPoolExecutor(5)
for i in range(10):
    # å¾€çº¿ç¨‹æ± ä¸Šå¡ä»»åŠ¡
    pool.submit(target)

####åˆ›å»ºçº¿ç¨‹æ± è¿˜å¯ä»¥ä½¿ç”¨æ›´ä¼˜é›…çš„æ–¹å¼ï¼Œå°±æ˜¯ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨####
with ThreadPoolExecutor(5) as pool:
    for i in range(100):
        pool.submit(target)
```

1. ä½¿ç”¨ with è¯­å¥ ï¼Œé€šè¿‡ ThreadPoolExecutor æ„é€ å®ä¾‹ï¼ŒåŒæ—¶ä¼ å…¥ max_workers å‚æ•°æ¥è®¾ç½®çº¿ç¨‹æ± ä¸­æœ€å¤šèƒ½åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°ç›®ã€‚
2. ä½¿ç”¨ submit å‡½æ•°æ¥æäº¤çº¿ç¨‹éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­ï¼Œå¹¶è¿”å›è¯¥ä»»åŠ¡çš„å¥æŸ„ï¼ˆç±»ä¼¼äºæ–‡ä»¶ã€ç”»å›¾ï¼‰ï¼Œæ³¨æ„ submit() ä¸æ˜¯é˜»å¡çš„ï¼Œè€Œæ˜¯ç«‹å³è¿”å›ã€‚
3. é€šè¿‡ä½¿ç”¨ done() æ–¹æ³•åˆ¤æ–­è¯¥ä»»åŠ¡æ˜¯å¦ç»“æŸã€‚ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œæäº¤ä»»åŠ¡åç«‹å³åˆ¤æ–­ä»»åŠ¡çŠ¶æ€ï¼Œæ˜¾ç¤ºå››ä¸ªä»»åŠ¡éƒ½æœªå®Œæˆã€‚åœ¨å»¶æ—¶2.5åï¼Œtask1 å’Œ task2 æ‰§è¡Œå®Œæ¯•ï¼Œtask3 ä»åœ¨æ‰§è¡Œä¸­
4. ä½¿ç”¨ result() æ–¹æ³•å¯ä»¥è·å–ä»»åŠ¡çš„è¿”å›å€¼ã€‚

### è‡ªå®šä¹‰çº¿ç¨‹æ± 

ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ¥è‡ªå®šä¹‰çº¿ç¨‹æ± 

```
import time
import threading
from queue import Queue

def target(queue):
    while True:
        task = queue.get()
        if task == "stop":
            queue.task_done()
            break

        task()
        queue.task_done()

def do_task():
    for i in range(5):
        print('running thread-{}:{}'.format(threading.get_ident(), i))
        time.sleep(1)

class MyQueue(Queue):
    def close(self):
        for i in range(self.maxsize):
            self.put("stop")

def custome_pool(task_func, max_workers):
    queue = MyQueue(max_workers)
    for n in range(max_workers):
        t = threading.Thread(target=task_func, args=(queue,))
        t.daemon = True
        t.start()
    return queue

pool = custome_pool(task_func=target, max_workers=5)

for i in range(10):
    pool.put(do_task)

pool.close()
pool.join()
```
